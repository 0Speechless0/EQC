@{
    EQC.Common.SessionManager sessionManager = new EQC.Common.SessionManager();
    EQC.Common.UserInfo userInfo = sessionManager.GetUser();
    string enterSignal = userInfo
        .MenuList.Select(row => row.Url)
        .FirstOrDefault(path =>
            path.Split('/')[0] == HttpContext.Current.Request.Url.AbsolutePath.Split('/')[1]
            || HttpContext.Current.Request.Url.AbsolutePath.StartsWith("/Portal")
            || HttpContext.Current.Request.Url.AbsolutePath.StartsWith("/CarbonReductionCal")
            );

    Dictionary<int, string> videoCodeDic = new Dictionary<int, string>()
    {
        { 12, "0bwPs7UOvt8"},
        { 10, "0rO17rfM4jw"},
        { 3, "WmdphqeZfGw"},
        { 4, "MAwm3SsDniQ"}
    };


    if (enterSignal == null)
    {
        Response.Redirect("/");
    }
    ViewBag.mainLeftClass = ViewBag.mainLeftClass ?? "main-left menu_bg_R";
    ViewBag.nvaClass = ViewBag.nvaClass ?? "navbar navbar-expand-lg fixed-top navbar-bg-R";
    ViewBag.cardClass = ViewBag.cardClass ?? "card whiteBG mb-4 colorset_R";
    ViewBag.hasCard = ViewBag.hasCard ?? true;
    ViewBag.footerClass = ViewBag.footerClass ?? "inside_footer footer-R";
    ViewBag.gotopBtnClass = ViewBag.gotopBtnClass ?? "btn-color1";
    ViewBag.userUnit = ViewBag.userUnit ?? "";
    ViewBag.userIcon = ViewBag.userIcon ?? "~/Content/images1/info_logo.png";
    bool isEngForm = HttpContext.Current.Request.Path.Contains("/EngForum");

    bool LeftMenuDisplay = !HttpContext.Current.Request.Path.Contains("/Portal")
        && !isEngForm;

    string rightContentStyle = LeftMenuDisplay ? "margin-left:230px" : "margin-left:30px";
    string bodyClass = HttpContext.Current.Request.Path.Contains("/PortalDepAdmin") ? "index mainpage-demobg" : "";
    string mainContentStyle= HttpContext.Current.Request.Path.Contains("/PortalDepAdmin") ? "margin-bottom:-112px" : "";
    int? systemSeq = (int)HttpContext.Current.Session["SystemType"];

    if (isEngForm)
    {
        ViewBag.mainLeftClass += " off";
    }

    var notifications = EQC.Common.NotificationProcesser.GetNotifications(userInfo);

    var notify = notifications.Count() > 0;

    string SerialNotifications= Newtonsoft.Json.JsonConvert.SerializeObject(notifications);
    var _SerialNotifications = HttpUtility.HtmlEncode(SerialNotifications);
    HttpCookie userIdCookie = new HttpCookie("SerialNotifications");

    userIdCookie.Value = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(SerialNotifications) );
    Response.Cookies.Add(userIdCookie);

    videoCodeDic.TryGetValue(systemSeq ?? 0, out string  videoCode);
}




<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>經濟部水利署-水利工程品管系統</title>
    <meta name="keywords" content="經濟部水利署,水利工程,品管系統">
    <meta name="description" content="經濟部水利署-水利工程品管系統">
    <!-- CSS -->
    <link rel="icon" href="@Url.Content("~/Content/images1/ROC_Water_Resources_Agency_Seal.svg")" type="image/ico" />
    <link href="@Url.Content("~/Content/css1/bootstrap.min.css")" rel="stylesheet">
    <link href="@Url.Content("~/Content/css1/fontawesome.min.css")" rel="stylesheet">
    <link rel="stylesheet" href="@Url.Content("~/Scripts/assets/libs/jquery-ui/jquery-ui.min.css")" />
    <!-- CSS -->
    <!-- Page Specific CSS -->
    <script type="text/javascript" src="@Url.Content("~/Content/js/jquery-3.6.0.min.js")"></script>
    <script src="@Url.Content("~/Scripts/assets/libs/jquery-ui/jquery-ui.min.js")"></script>
    <script src="@Url.Content("~/Scripts/assets/libs/jquery-ui-i18n/ui/i18n/datepicker-zh-TW.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Content/js/bootstrap.min.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Content/js/script.js")"></script>
    <!--自訂RWD設定-->
    <!--[if lt IE 9]>
      <script src="@Url.Content("~/assets/js/html5shiv.min.js")"></script>
      <script src="@Url.Content("~/assets/js/respond.min.js")"></script>
    <![endif]-->
    <script src="@Url.Content("~/Content/qrcode.js")"></script>
</head>

<header>
    <nav class="@ViewBag.nvaClass">
        <a class="navbar-brand" href="@Url.Content(sessionManager.GetUserHome())" title="回首頁"><img src="@Url.Content("~/Content/images1/major_logo.png")" alt="經濟部水利署logo"></a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="主選單開合">
            <i class="fas fa-bars fa-2x"></i>
        </button>
        <div class="navbar-collapse collapse" id="navbarCollapse">
            <ul class="navbar-nav nav-top ml-auto" style="max-width:60%">
                @{
                    if (userInfo != null && userInfo.SystemList != null)
                    {
                        foreach (EQC.ViewModel.VSystemMenu system in userInfo.SystemList)
                        {
                            <li class="nav-item">
                                <a class="nav-link" href="../@system.PathName" title='@system.Name'> @system.Name</a>
                            </li>
                        }
                    }
                }
                <li class="nav-item">
                    <a class="nav-link" href="@Url.Action("LoginOut", "Login")" title="登出">登出</a>
                </li>
            </ul>
        </div>
    </nav>
</header>
<body class="@bodyClass">
    <div id="WRAPPER" class="container-fluid" style="@mainContentStyle">
        <div style="position: absolute ;top:150px; right: 50px; z-index: 1; display: none;" id="info">
            <img src="/Content/images1/info.png" style="
    width: 400px;
">
        </div>
        <!-- 內容開始 -->
        @if (LeftMenuDisplay)
        {
            <div id="leftMenuBody" class="@ViewBag.mainLeftClass">
                <div id="leftMenuTab" class="menu-control btn-color13">
                    <i class="fa fa-chevron-left" aria-hidden="true"></i>
                </div>

                <div class="card" id="accordion" role="tablist" aria-multiselectable="true">
                    @{
                        if (userInfo != null && userInfo.MenuList != null)
                        {
                            foreach (EQC.ViewModel.VMenu menuVM in userInfo.MenuList.Where(w => w.ParentSeq > 0 && w.SystemTypeSeq == systemSeq))
                            {
                                <div class="card">
                                    <div class="card-header" role="tab" id="heading3">
                                        <h4 class="card-title">
                                            @if (!string.IsNullOrEmpty(menuVM.Url) && menuVM.Url.Split('/').Count() > 1)
                                            {
                                                if (@ViewBag.Title == @menuVM.Name)
                                                {
                                                    <a class="chosen" role="button" href="@Url.Action(menuVM.Url.Split('/')[1], menuVM.Url.Split('/')[0])">
                                                        @menuVM.Name
                                                    </a>
                                                }
                                                else
                                                {
                                                    <a class="collapsed" role="button" href="@Url.Action(menuVM.Url.Split('/')[1], menuVM.Url.Split('/')[0])">
                                                        @menuVM.Name
                                                    </a>
                                                }
                                            }
                                            else
                                            {
                                                <a class="collapsed" role="button" href="#">
                                                    @menuVM.Name
                                                </a>
                                            }
                                        </h4>
                                    </div>
                                    <div id="@menuVM.Name" class="collapse" role="tabpanel" aria-labelledby="heading1" data-parent="#accordion"></div>
                                </div>
                            }
                        }
                    }
                </div>
            </div>
        }
        @if (HttpContext.Current.Request.Path.Contains("/PortalDepAdmin"))
        {
            <div class="box">
                @RenderBody()
            </div>
        }

        else if (HttpContext.Current.Request.Path.Contains("/PortalDepUser"))
        {
            <div class="container" style="padding-top: 80px;">
                <div class="row mb-3">
                    <div class="col-12 col-md-8">
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="name">
                            <img class="role-icon" src="@Url.Content(@ViewBag.userIcon)">
                            歡迎！ &nbsp;@userInfo.DisplayName @ViewBag.userUnit
                        </div>
                    </div>
                </div>
                <!-- 內容開始 -->
                @RenderBody()

            </div>
        }
        else
        {

            <div class="main-right" style="@rightContentStyle ">
                <div class="d-flex mb-3 justify-content-end">
                    <div onclick="showInfo()">
                        <img src="@Url.Content("~/Content/images1/info_logo.png")" style="width:80px; height:60px">
                    </div>
                    <div>

                        <div class="name">
                            歡迎！ &nbsp;@userInfo.DisplayName
                        </div>
                    </div>
                </div>
                @if (ViewBag.hasCard)
                {
                    <div class="@ViewBag.cardClass">
                        <div class="card-header d-flex">
                            <h3 class="card-title font-weight-bold">@ViewBag.BarTitle</h3>
                            <div class="mt-auto">
                                @if(videoCode != null)
                                {
                                    <a style="color: white;" href="@("https://www.youtube.com/watch?v="+ videoCode + "&ab_channel=敦陽科技" )" target="_blank">
                                        操作影片
                                    </a>
                                }


                            </div>
                        </div>
                        <div class="card-body">
                            @RenderBody()

                        </div>
                    </div>
                }
                else
                { <div class="@ViewBag.cardClass">
                        @RenderBody()
                    </div>
                }

            </div>
        }
        @if (notify)
        {
            <ptt-modal></ptt-modal>
        }

    </div>
    <footer class="@ViewBag.footerClass">
        <div class="container d-flex justify-content-end" ">
            <div class="mr-5">客服專線:0905-546-726</div>
            <div>
                經濟部水利署 Copyright © 2021 All Rights Reserved
            </div>

        </div>
        <div id="gotop" class="@ViewBag.gotopBtn" title="回到最上方"><img src="@Url.Content("~/Content/images1/icon-up.png")" alt="回到最上方icon"></div>
    </footer>

    <!-- CSS 設定-->
    <link href="@Url.Content("~/Content/dist/css/app.css")" rel="stylesheet">
    <link href="@Url.Content("~/Content/css1/all.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/css1/layout.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/css1/rwd.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Content/css1/drag.css")" rel="stylesheet" />

    <!-- script>
        $(function () {
            $('.datepicker').datepicker({
                dateFormat: 'yy/mm/dd',
                regional: 'zh-TW',
                changeMonth: true,
                changeYear: true,
            });

        });
    <script -->

    <script src=@Url.Content("~/Content/dist/js/app.js")></script>

    <script>
        window.QRCodeImageGenerate = (id, url) =>
        {
            var QrcodeDiv = document.getElementById(id);
            QrcodeDiv.innerHTML = "";

            new QRCode(QrcodeDiv, url);

        }

        document.oncontextmenu = new Function("return false");
        oncontextmenu = "return false;"
        var app = new Vue({
            //store,
            //render: (h) => h(App),
        }).$mount('#WRAPPER');

        localStorage.setItem('isAdmin', '@userInfo.IsAdmin');
        localStorage.setItem('isEQCAdmin', '@userInfo.IsEQCAdmin');
        localStorage.setItem('tarEdit', 'Edit3');

        window.openModal = (id) => $(id).modal('show');
        window.closeModal = (id) => $(id).modal('hide');

            let info = {};
    let infoCreateTime;
    let seq = 0;
    let a = 0;

    const scroll = document.querySelector("#accordion");
        if (scroll != null) {

            scroll.scrollTop = localStorage.getItem("scrollTop") ?? 0;
            scroll.addEventListener("scroll", event => {
                localStorage.setItem("scrollTop", scroll.scrollTop);
            }, { passive: true });
        }

        //console.log(document.getElementById("leftMenu"));
        //document.getElementById("leftMenu").click();
    //$('#myModal').on('hidden.bs.modal', function () {
    //    getPttContent()
    //});


        localStorage.setItem('Role', '@userInfo.RoleSeq');
        //localStorage.setItem('SerialNotifications', '@SerialNotifications')
    //getPttContent();

    //function getPttContent() {
    //    $.ajax({
    //        url: "/PttInfo/GetPttInfo",
    //        type: "post",
    //        dataType: "html",
    //        data: {
    //            seq : seq++
    //        },
    //        success: function (config) {
    //            var jsonData = JSON.parse(config);
    //            console.log(jsonData);
    //            if (jsonData.result != 0) {
    //                closePtt();
    //                return;
    //            }
    //            info = jsonData.info
    //            infoCreateTime = jsonData.infoCreateTime;
    //            document.getElementById("pttHtml").innerHTML = info.Html;
    //            document.getElementById("pttTitle").innerHTML = info.Title;
    //            $('#myModal').modal('show');
    //        },
    //        error: function (err) {

    //        }
    //    });
    //}


    //async function checkPtt() {

    //    $.ajax({
    //        url: "/PttInfo/CheckPtt",
    //        type: "post",
    //        dataType: "html",
    //        data: {
    //            checkTime: infoCreateTime
    //        },
    //        success: function (config) {
    //            var jsonData = JSON.parse(config);
    //            if (jsonData.result != 0) return;
    //            seq--;
    //            $('#myModal').modal('show');
    //            getPttContent();
    //        },
    //        error: function (err) {

    //        }
    //    });
    //}

    function closePtt() {
        $('#myModal').modal('hide');
    }
    function showInfo() {
        a++;
        if(a % 2 == 1)
            $("#info").show();
        else $("#info").hide()
    }
    </script>

    @RenderSection("scripts", required: false)
</body>
</html>